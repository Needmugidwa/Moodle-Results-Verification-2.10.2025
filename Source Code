import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import pandas as pd
import os

# Global variables
excel_file = None
excel_file2 = None

# Campus options
CAMPUSES = [
    "NEWTOWN CAMPUS",
    "Cape Town - Long Street",
    "PLK 52 CHURCH STREET - CONTACT",
    "Umhlanga Park Square",
    "DISTANCE LEARNING",
    "CENTURION CAMPUS",
    "Umhlanga Park Square",
    "291 HELEN JOSEPH CAMPUS",
    "Bryanston - Richfield"
]


def validate_moodle_file(file_path):
    """Validate the Moodle Excel file format and required columns"""
    try:
        df = pd.read_excel(file_path)
        required_columns = ['Last name', 'First name', 'Username', 'Assignment', 'Test', 'EXAM', 'Institution']

        missing_columns = [col for col in required_columns if col not in df.columns]
        if missing_columns:
            messagebox.showerror("Error", f"Moodle file is missing required columns: {', '.join(missing_columns)}")
            return False
        return True
    except Exception as e:
        messagebox.showerror("Error", f"Error reading Moodle file: {str(e)}")
        return False


def validate_its_file(file_path):
    """Validate the ITS Excel file format and required columns"""
    try:
        df = pd.read_excel(file_path)
        required_columns = ['Student Number', 'Full Period Mark', 'Exam Mark', 'Final Mark', 'Offering Type']

        missing_columns = [col for col in required_columns if col not in df.columns]
        if missing_columns:
            messagebox.showerror("Error", f"ITS file is missing required columns: {', '.join(missing_columns)}")
            return False
        return True
    except Exception as e:
        messagebox.showerror("Error", f"Error reading ITS file: {str(e)}")
        return False


def open_file_dialog():
    """Open file dialog for Moodle Excel file"""
    file_path = filedialog.askopenfilename(
        title="Select Moodle Excel File",
        filetypes=[("Excel files", "*.xlsx"), ("Excel files", "*.xls")]
    )
    if file_path:
        if validate_moodle_file(file_path):
            global excel_file
            excel_file = file_path
            moodle_file_label.config(text=f"Moodle File: {os.path.basename(file_path)}", fg="green")
            check_ready_to_execute()
        else:
            excel_file = None
            moodle_file_label.config(text="No Moodle file selected", fg="red")


def open_file_dialog2():
    """Open file dialog for ITS Excel file"""
    file_path2 = filedialog.askopenfilename(
        title="Select ITS Excel File",
        filetypes=[("Excel files", "*.xlsx"), ("Excel files", "*.xls")]
    )
    if file_path2:
        if validate_its_file(file_path2):
            global excel_file2
            excel_file2 = file_path2
            its_file_label.config(text=f"ITS File: {os.path.basename(file_path2)}", fg="green")
            check_ready_to_execute()
        else:
            excel_file2 = None
            its_file_label.config(text="No ITS file selected", fg="red")


def check_ready_to_execute():
    """Check if all requirements are met to enable execute button"""
    if excel_file and excel_file2 and campus_var.get():
        execute_button.config(state="normal")
    else:
        execute_button.config(state="disabled")


def reset_files():
    """Reset all selected files and clear labels"""
    global excel_file, excel_file2
    excel_file = None
    excel_file2 = None
    moodle_file_label.config(text="No Moodle file selected", fg="red")
    its_file_label.config(text="No ITS file selected", fg="red")
    campus_var.set("")
    execute_button.config(state="disabled")
    messagebox.showinfo("Reset", "All files have been cleared. Please select new files.")


def execute_operation():
    """Execute the main operation with selected files and campus"""
    try:
        if not excel_file or not excel_file2:
            messagebox.showerror("Error", "Please select both Excel files before executing.")
            return

        if not campus_var.get():
            messagebox.showerror("Error", "Please select a campus before executing.")
            return

        # Read Excel files
        df = pd.read_excel(excel_file)
        df2 = pd.read_excel(excel_file2)

        # Data type conversions
        if df['Username'].dtype != 'object':
            df['Username'] = df['Username'].astype(str)
        if df2['Student Number'].dtype != 'object':
            df2['Username'] = df2['Student Number'].astype(str)

        df2['Username'] = df2['Username'].str.rstrip('.')

        # Filter by selected campus
        target_institution = campus_var.get()
        filtered_df = df[df['Institution'] == target_institution].copy()

        if filtered_df.empty:
            messagebox.showerror("Error",
                                 f"No data found for {target_institution}. Please check the campus name in your data.")
            return

        filtered_df2 = df2[df2['Offering Type'] == "B7"].copy()

        if filtered_df2.empty:
            messagebox.showerror("Error", "No data found with Offering Type 'B7' in ITS file.")
            return

        # Select required columns
        columns = ["Last name", "First name", "Username", "Assignment", "Test", "EXAM"]
        columns2 = ["Username", "Full Period Mark", "Exam Mark", "Final Mark"]

        filtered_df = filtered_df[columns]
        filtered_df2 = filtered_df2[columns2]

        # Replace "-" values with zeros
        columns_to_replace = ["Assignment", "Test", "EXAM"]
        filtered_df[columns_to_replace] = filtered_df[columns_to_replace].replace('-', 0)
        filtered_df[columns_to_replace] = filtered_df[columns_to_replace].apply(pd.to_numeric, errors='coerce')

        # Convert to float
        filtered_df["Assignment"] = filtered_df["Assignment"].astype(float)
        filtered_df["Test"] = filtered_df["Test"].astype(float)
        filtered_df["EXAM"] = filtered_df["EXAM"].astype(float)

        # Calculate marks
        filtered_df['FP Mark'] = 0.50 * filtered_df["Assignment"] + 0.50 * filtered_df['Test'] + 0.5
        filtered_df['Final Mark Moodle'] = 0.40 * filtered_df['FP Mark'] + 0.60 * filtered_df['EXAM'] + 0.5

        # Format columns
        columns_to_format = ['FP Mark', 'Final Mark Moodle']
        filtered_df[columns_to_format] = filtered_df[columns_to_format].astype(int)

        # Merge DataFrames
        merged_df = pd.merge(filtered_df, filtered_df2, on='Username', how='inner')
        merged_df['FP_Difference'] = merged_df['FP Mark'] - merged_df["Full Period Mark"]
        merged_df["FM_Diff"] = merged_df["Final Mark"] - merged_df['Final Mark Moodle']

        # Calculate statistics
        number_wrote = (filtered_df['Final Mark Moodle'] > 0).sum()
        passed = (filtered_df['Final Mark Moodle'] >= 50).sum()
        failed = filtered_df['Final Mark Moodle'].between(1, 49).sum()
        passed_above75 = (filtered_df['Final Mark Moodle'] >= 75).sum()
        passed_70_to_74 = filtered_df['Final Mark Moodle'].between(70, 74).sum()
        passed_60_to_69 = filtered_df['Final Mark Moodle'].between(60, 69).sum()
        passed_50_to_59 = filtered_df['Final Mark Moodle'].between(50, 59).sum()
        passed_40_to_49 = filtered_df['Final Mark Moodle'].between(40, 49).sum()

        if number_wrote > 0:
            perc_passed = "{:.1%}".format(passed / number_wrote)
            perc_failed = "{:.1%}".format(failed / number_wrote)
        else:
            perc_passed = "0.0%"
            perc_failed = "0.0%"

        # Generate output file names
        characters_to_insert = "Filtered"
        certain_character = ".xlsx"
        index = excel_file.find(certain_character)

        if index != -1:
            excel_out = excel_file[:index] + characters_to_insert + excel_file[index:]
            excel_out2 = excel_file[:index] + characters_to_insert + "_merged" + excel_file[index:]
        else:
            excel_out = excel_file + "_filtered.xlsx"
            excel_out2 = excel_file + "_merged.xlsx"

        # Create results text file
        results = excel_out.replace(".xlsx", ".txt")
        with open(results, "w") as file:
            file.write(f"Campus: {target_institution}\n")
            file.write("=" * 50 + "\n")
            file.write("No. Wrote \t:- " + str(number_wrote) + "\n")
            file.write("No. Passed \t:- " + str(passed) + "\n")
            file.write("No. Failed \t:- " + str(failed) + "\n")
            file.write("Pass Rate \t:- " + str(perc_passed) + "\n")
            file.write("Fail Rate \t:- " + str(perc_failed) + "\n")
            file.write("******** Performance Analysis ******\n")
            file.write("No. Over 75% \t:- " + str(passed_above75) + "\n")
            file.write("No. 70% to 75% \t:- " + str(passed_70_to_74) + "\n")
            file.write("No. 60% to 69% \t:- " + str(passed_60_to_69) + "\n")
            file.write("No. 50% to 59% \t:- " + str(passed_50_to_59) + "\n")
            file.write("No. 40% to 49% \t:- " + str(passed_40_to_49) + "\n")
            file.write("No. 0% to 49% \t:- " + str(failed) + "\n")

        # Save Excel files
        filtered_df = filtered_df.sort_values(by="Username")
        filtered_df.to_excel(excel_out, index=False)

        merged_df = merged_df.sort_values(by="Username")
        merged_df.to_excel(excel_out2, index=False)

        messagebox.showinfo("Success",
                            f"Operation completed successfully!\n\nFiles generated:\n1. {os.path.basename(excel_out)}\n2. {os.path.basename(excel_out2)}\n3. {os.path.basename(results)}")

    except Exception as e:
        messagebox.showerror("Error", f"An error occurred during processing: {str(e)}")


def on_campus_change(*args):
    """Called when campus selection changes"""
    check_ready_to_execute()


# Create the main window
root = tk.Tk()
root.title("RICHFIELD EXAM Auto Verification - NM Solutions")

width = root.winfo_screenwidth()
height = root.winfo_screenheight()
root.geometry("%dx%d" % (width, height))

# Header
label_header = tk.Label(root, text="Welcome to the Richfield Results Auto Verification APP",
                        justify=tk.LEFT, fg="Red", font=("Arial", 20))
label_header.pack(padx=10, pady=10)

# Instructions
instructions = """Please follow the instructions below:

1. Download the Excel file with assessment and exam marks from Moodle.
2. Rename the column with assignment marks to "Assignment".
3. Rename the column with CA test marks to "Test".
4. Rename the column with exam marks to "EXAM".
5. Save the Excel file as an Excel workbook, without changing the name.

NB: Avoid spaces when renaming the columns in steps 2, 3, and 4.
Save the Excel file from ITS as an Excel workbook.

Choose the files using the buttons below and select your campus."""

label = tk.Label(root, text=instructions, justify=tk.LEFT, fg="blue", font=("Helvetica", 12))
label.pack(padx=15, pady=15)

# Campus selection
campus_frame = tk.Frame(root)
campus_frame.pack(pady=10)

campus_label = tk.Label(campus_frame, text="Select Campus:", font=('Calibri', 14, 'bold'))
campus_label.pack(side=tk.LEFT, padx=5)

campus_var = tk.StringVar()
campus_var.trace('w', on_campus_change)
campus_dropdown = ttk.Combobox(campus_frame, textvariable=campus_var, values=CAMPUSES,
                               state="readonly", font=('Calibri', 12), width=30)
campus_dropdown.pack(side=tk.LEFT, padx=5)

# File selection buttons and labels
file_frame = tk.Frame(root)
file_frame.pack(pady=20)

# Moodle file selection
moodle_button = tk.Button(file_frame, text="Choose the Excel File From Moodle",
                          command=open_file_dialog, font=('Calibri', 15, 'bold'))
moodle_button.pack(pady=10)

moodle_file_label = tk.Label(file_frame, text="No Moodle file selected", fg="red", font=('Calibri', 12))
moodle_file_label.pack(pady=5)

# ITS file selection
its_button = tk.Button(file_frame, text="Choose the ITS Excel File",
                       command=open_file_dialog2, font=('Calibri', 15, 'bold'))
its_button.pack(pady=10)

its_file_label = tk.Label(file_frame, text="No ITS file selected", fg="red", font=('Calibri', 12))
its_file_label.pack(pady=5)

# Control buttons
control_frame = tk.Frame(root)
control_frame.pack(pady=30)

execute_button = tk.Button(control_frame, text="Execute Operation", command=execute_operation,
                           font=('Calibri', 16, 'bold'), bg="green", fg="white",
                           state="disabled", width=20)
execute_button.pack(side=tk.LEFT, padx=10)

reset_button = tk.Button(control_frame, text="Reset", command=reset_files,
                         font=('Calibri', 16, 'bold'), bg="orange", fg="white", width=15)
reset_button.pack(side=tk.LEFT, padx=10)

# Status label
status_label = tk.Label(root, text="Please select files and campus to continue",
                        font=('Calibri', 12), fg="gray")
status_label.pack(pady=10)

# Start the main event loop
root.mainloop()
